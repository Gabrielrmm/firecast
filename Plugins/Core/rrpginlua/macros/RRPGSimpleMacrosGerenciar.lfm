<?xml version="1.0" encoding="UTF-8"?>
<popupForm name="frmGerenciarSimpleMacros" title="@@macros.ui.manageMacros" width="450" height="480" resizable="true">
	<import file="../interfaceUtils.xml"/>

	<!-- Popup de Edição da Macro -->
	<popup name="popEditMacro" autoScopeNode="false">
		<event name="onClose">
			self.popEditMacro:setNodeObject(nil);
		</event>
		
		<style>
			.dynSize {
				g-dyn-width-txt: true;
				g-dyn-height-txt: true;
			}
		</style>
		
		<scrollBox align="client" g-cnt-gutter="16" g-cnt-line-spacing="4">	
			<row g-cnt-min-grid-width="120" g-cnt-vert-align="center" g-margin-top="4">
				<label g="col" text="@@macros.ui.editLabel" horzTextAlign="center" fontSize="16" g-width="12" g-dyn-height-txt="true"  />
				<button g="block" text="@@macros.ui.closeButton" onClick="self.popEditMacro:close();"  class="dynSize"  g-min-width="80" />					
			</row>
					
			<horzLine g="col" g-width="12" margins="{top=4, bottom=2}" strokeColor="white"/>		
						
			<row g-margin-top="8">
				<label g="col" text="@@macros.ui.nameLabel" class="dynSize"/>
				<label g="col" text="@@macros.ui.nameLabel.Orientation" fontSize="12" fontColor="gray" wordWrap="false" class="dynSize" g-break-line-before="true"/>	
				
				<edit g="col" name="edtNomeDaMacro" field="macro" textPrompt="@@macros.ui.macroName.example" g-margin-top="6"
					  g-width="12" g-min-height="30" g-max-width="250" g-dyn-height-txt="true" g-break-line-before="true"/>				
			</row>
						
			<row g-margin-top="4" g-vert-align="center" g-cnt-line-spacing="4">
				<radioButton g="block" class="dynSize" groupName="tipoMacro" field="tipoMacro" fieldValue="S" text="@@macros.ui.macroType.simple"/>
				<radioButton g="block" class="dynSize" groupName="tipoMacro" field="tipoMacro" fieldValue="L" text="@@macros.ui.macroType.lua" margins="{right=8}"/>
				<button g="block" class="dynSize" text="???" width="45" onClick="GUI.openInBrowser('https://firecast.app/sdk3/RRPG%20SDK%203.html?Macros.html');"/>
			</row>																	

			<row g-vert-tile="true" g-min-height="160" g-vert-align="bottom" g-margin-top="4">
				<label g="block" class="dynSize" text="@@macros.ui.actionsTitle" vertTextAlign="trailing"/>
				<label g="block" class="dynSize" name="labExtraInfoAcoes" text="@@macros.ui.macroType.onePerLine" fontSize="12" fontColor="gray" wordWrap="false" vertTextAlign="trailing" g-gutter="0"/>				
				
				<textEditor g="col" g-width="12" field="acoes" wordWrap="false" g-vert-tile="true" g-break-line-before="true" g-break-line-after="true" g-margin-top="6"/>						
			</row>
			
			<button g="block" g-margin-top="8" g-margin-bottom="4" class="dynSize" text="@@macros.ui.deleteMacro" g-min-width="100" g-min-height="30">
				<event name="OnClick">
					Dialogs.confirmYesNo(lang("macros.ui.deleteConfirmation"),
						function (confirmado)
							if confirmado then
								local node = self.popEditMacro:getNodeObject();								
								self.popEditMacro:close();						
								
								if node ~= nil then
									NDB.deleteNode(node);
									globalMacrosInvalido = true;
								end;
							end;
						end);
				</event>
			</button>				
		</scrollBox>
		
		<dataLink fields="{'macro', 'acoes'}" onChange="globalMacrosInvalido = true;"/>		
		<dataLink field="tipoMacro" defaultValue="S">
			<event name="onChange">
				self.labExtraInfoAcoes.visible = self.popEditMacro:getNodeObject().tipoMacro ~= "L"; 
			</event>
		</dataLink>
		<dataLink field="macro" onChange="self.popEditMacro:getNodeObject().macro = globalPrepareMacroName(self.popEditMacro:getNodeObject().macro);"/>
		
		<event name="onCalculateSize"><![CDATA[
			local w = (self.width or 0) * 0.8;
			local h = (self.height or 0) * 0.8;
				
			if w < 250 then
				w = 250;
			elseif w > 1000 then
				w = 1000;
			end;
			
			if h < 280 then
				h = 280;
			elseif h > 1000 then
				h = 1000;
			end;
		
			return w, h;						
			]]>
		</event>		
	</popup>	

	<script><![CDATA[		
		function self.editarMacroNode(node)
			if node ~= nil then
				self.popEditMacro:setNodeObject(node);	
				self.popEditMacro:show();
				
				setTimeout(
					function()
						if self.edtNomeDaMacro.text == "" then
							self.edtNomeDaMacro:setFocus();
						end;
					end, 10);
			end;
		end;
	]]>
	</script>	
		
		
	<!-- Tabs da janela -->	
	<tabControl align="client">
		<tab title="@@macros.ui.title.macrosForEveryoneOnRoom" name="tabMacroMesa">
			<dataScopeBox name="dsbMacrosMesaGlobal" align="client">
				<layout align="client" margins="{left=2, top=2, right=2, bottom=2}">
						<layout align="top" height="25" margins="{left=2, right=2, bottom=8}">
							<label name="labTitMesa2" text="@@macros.ui.room" align="client" horzTextAlign="center" fontSize="16" fontStyle="bold"/>										
						</layout>					
				
					<layout align="top" height="28" margins="{bottom=5, top=5, left=5}">
						<button text="@@macros.ui.roomMacro.newTitle" align="left" width="150" onClick="self.editarMacroNode(self.rclMacrosDaMesaGlobal:append());"/>
					</layout>
					
					<recordList name="rclMacrosDaMesaGlobal" align="client" field="macros" 
								templateForm="frmGerenciarSimpleMacrosItem" selectable="true"/>
				</layout>
			</dataScopeBox>
		</tab>
	
		<tab title="@@macros.ui.myMacros.title">
			<tabControl align="client">
				<tab title="@@macros.ui.myMacros.global.title">
					<layout align="client" margins="{left=2, top=2, right=2, bottom=2}">
						<layout align="top" height="28" margins="{bottom=5, top=5, left=5}">
							<button text="@@macros.ui.myMacros.global.new.title" align="left" width="150" onClick="self.editarMacroNode(self.rclMacrosGlobais:append());"/>
						</layout>
						
						<recordList name="rclMacrosGlobais" align="client" field="macros" 
									templateForm="frmGerenciarSimpleMacrosItem" selectable="true"/>
					</layout>
				</tab>
				
				<tab name="tabMacrosDaMesa" title="@@macros.ui.myMacros.thisroom.title">
					<dataScopeBox name="dsbMacrosDaMesa" align="client">
						<layout align="client" margins="{left=2, top=2, right=2, bottom=2}">
							<layout align="top" height="25" margins="{left=2, right=2, bottom=8}">
								<label name="labTitMesa" text="@@macros.ui.room" align="client" horzTextAlign="center" fontSize="16" fontStyle="bold"/>			
								
							</layout>				
								
						
							<layout align="top" height="28" margins="{bottom=3}">
								<button text="@@macros.ui.myMacros.thisroom.new.title" align="left" width="180" onClick="self.editarMacroNode(self.rclMacrosDaMesa:append());"/>
							</layout>
							
							<recordList name="rclMacrosDaMesa" align="client" field="macros" 
										templateForm="frmGerenciarSimpleMacrosItem" selectable="true"/>
						</layout>				
					</dataScopeBox>
				</tab>
			</tabControl>
		</tab>
	

	</tabControl>	
	
	<event name="onShow">	
    globalNeedSimpleMacrosNDB();
	
		if globalSimpleMacrosNDB.global == nil then
			globalSimpleMacrosNDB.global = {};
		end;
		
		self:setNodeObject(globalSimpleMacrosNDB.global);
		
		if self._mesa ~= nil then
			self.tabMacrosDaMesa.visible = true;
					
			if globalSimpleMacrosNDB.mesas == nil then
				globalSimpleMacrosNDB.mesas = {};
			end;	

			if globalSimpleMacrosNDB.mesas[self._mesa.codigoInterno] == nil then
				globalSimpleMacrosNDB.mesas[self._mesa.codigoInterno] = {};
			end;	
			
			self.dsbMacrosDaMesa.node = globalSimpleMacrosNDB.mesas[self._mesa.codigoInterno];
			self.labTitMesa.text = "Mesa: " .. self._mesa.nome;
			self.labTitMesa2.text = self.labTitMesa.text;
			
			local opcoes = {};
			local travouForm = false;
			opcoes.criar = true;
			opcoes.callbackDeCarga = function()
										self:lockWithActivity(lang("macros.ui.loadingMacrosForRoom"));
										travouForm = true;
									 end;
			
			self._mesa:abrirNDBDeMesa("RRPG_Macros", 
				function(nG)
					if travouForm then
						self:unlockWithActivity();
					end;					
					
					if nG ~= nil then
						self.dsbMacrosMesaGlobal.node = nG;
					else
						self.tabMacroMesa.visible = false;
					end;
				end, opcoes)
			
		else
			self.tabMacrosDaMesa.visible = false;
			self.dsbMacrosDaMesa.node = nil;
			self.tabMacroMesa.visible = false;
		end;
	</event>
	
	<event name="onHide">
		self.dsbMacrosDaMesa.node = nil;
		self:setNodeObject(nil);
	</event>
			
</popupForm>